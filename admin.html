<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Typing Results Admin</title>
    <meta name="color-scheme" content="light dark">
    <style>
        :root{
            --bg: #0b1020;
            --panel: #111936;
            --muted: #9aa3b2;
            --text: #e6e9ef;
            --accent: #6aa6ff;
            --accent-2: #7c4dff;
            --ok: #22c55e;
            --warn: #f59e0b;
            --danger: #ef4444;
            --border: rgba(255,255,255,.08);
            --row: rgba(255,255,255,.03);
            --row-alt: rgba(255,255,255,.05);
            --shadow: 0 10px 30px rgba(0,0,0,.35);
        }
        @media (prefers-color-scheme: light) {
            :root{
                --bg: #f6f8fb;
                --panel: #ffffff;
                --muted: #5b6471;
                --text: #131722;
                --accent: #2563eb;
                --accent-2: #7c3aed;
                --border: rgba(0,0,0,.08);
                --row: rgba(0,0,0,.02);
                --row-alt: rgba(0,0,0,.04);
                --shadow: 0 10px 30px rgba(0,0,0,.08);
            }
        }
        * { box-sizing: border-box }
        html,body { height:100% }
        body{
            margin:0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
            color: var(--text);
            background:
                radial-gradient(1200px 600px at 20% -10%, color-mix(in oklab, var(--accent) 22%, transparent), transparent),
                radial-gradient(1000px 500px at 95% 0%, color-mix(in oklab, var(--accent-2) 18%, transparent), transparent),
                var(--bg);
            min-height:100%;
        }
        .wrap{
            max-width: 1100px;
            margin: clamp(16px, 3vw, 28px) auto;
            padding: 0 16px 48px;
        }
        .hero{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:16px;
            margin-bottom: 18px;
        }
        .title{
            font-weight: 800;
            letter-spacing: -0.02em;
            font-size: clamp(20px, 2.8vw, 36px);
            line-height: 1.1;
            margin: 0;
        }
        .subtitle{
            margin: 6px 0 0;
            color: var(--muted);
            font-size: clamp(12px, 1.3vw, 14px);
        }
        .card{
            background: color-mix(in oklab, var(--panel) 92%, transparent);
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        .toolbar{
            display:flex;
            flex-wrap:wrap;
            gap:10px;
            align-items:center;
            padding: 14px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, color-mix(in oklab, var(--panel) 98%, transparent), transparent);
        }
        .input{
            flex:1 1 240px;
            display:flex;
            align-items:center;
            gap:8px;
            background: color-mix(in oklab, var(--panel) 96%, transparent);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 12px;
            color: var(--text);
        }
        .input input{
            flex: 1 1 auto;
            border:0;
            outline:0;
            background: transparent;
            color: inherit;
            font: inherit;
            min-width: 120px;
        }
        .btn{
            appearance:none;
            border:1px solid var(--border);
            background: linear-gradient(180deg, color-mix(in oklab, var(--panel) 98%, transparent), color-mix(in oklab, var(--panel) 92%, transparent));
            color: var(--text);
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform .05s ease, background .2s ease, border-color .2s ease;
        }
        .btn:hover{ transform: translateY(-1px) }
        .btn:active{ transform: translateY(0) scale(.99) }
        .btn-primary{
            border-color: color-mix(in oklab, var(--accent) 40%, transparent);
            background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 18%, var(--panel)), color-mix(in oklab, var(--panel) 92%, transparent));
        }

        .table-wrap{ overflow:auto; max-height: calc(80vh); }
        table{
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        thead th{
            position: sticky;
            top: 0;
            background: color-mix(in oklab, var(--panel) 98%, transparent);
            backdrop-filter: blur(6px);
            border-bottom: 1px solid var(--border);
            padding: 12px;
            text-align: left;
            color: var(--muted);
            font-weight: 700;
            letter-spacing: .02em;
            z-index: 1;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }
        tbody td{
            padding: 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        tbody tr:nth-child(odd){ background: var(--row) }
        tbody tr:nth-child(even){ background: var(--row-alt) }
        tbody tr:hover{ outline: 2px solid color-mix(in oklab, var(--accent) 35%, transparent) }
        .muted{ color: var(--muted) }
        .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace }
        .badge{
            display:inline-flex; align-items:center; gap:6px;
            background: color-mix(in oklab, var(--ok) 18%, transparent);
            color: color-mix(in oklab, var(--ok) 85%, var(--text));
            border: 1px solid color-mix(in oklab, var(--ok) 45%, transparent);
            padding: 6px 10px; border-radius: 999px; font-weight: 700;
        }
        .empty{
            text-align:center;
            padding: 38px 18px 48px;
            color: var(--muted);
        }
        .meta{
            display:flex; justify-content:space-between; align-items:center;
            gap:10px; padding: 10px 14px; color: var(--muted); font-size: 12px;
            border-top: 1px dashed var(--border);
        }
        .pill{
            display:inline-block; padding: 2px 8px; border-radius:999px;
            border:1px solid var(--border); background: color-mix(in oklab, var(--panel) 96%, transparent);
            margin-left: 6px; color: var(--text);
        }
        .sort{
            display:inline-flex; gap:4px; margin-left: 6px; color: var(--muted);
            opacity:.8; font-size: 12px; vertical-align: middle;
        }
        .sr-only{ position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden; }
        .actions{ display:flex; gap:8px; flex-wrap:wrap }
        .small{ font-size: 12px; padding: 8px 10px; }
    </style>
</head>
<body>
    <div class="wrap">
        <header class="hero">
            <div>
                <h1 class="title">Typing Results</h1>
            </div>
            <div class="actions">
                <button id="refreshBtn" class="btn btn-primary small" title="Reload from localStorage">Refresh</button>
                <button id="exportBtn" class="btn small" title="Download as CSV">Export CSV</button>
                <button id="logoutBtn" class="btn small" title="Go to login" type="button" onclick="window.location.href='admin-login.html'">Logout</button>
            </div>
        </header>

        <section class="card">
            <div class="toolbar">
                <div class="input" role="search">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M21 21l-4.2-4.2M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                    </svg>
                    <input id="search" placeholder="Search name, email, hall ticket…" autocomplete="off" />
                </div>
                <div class="muted mono" id="count"></div>
            </div>

            <div class="table-wrap">
                <table id="table" aria-describedby="tableCaption">
                    <caption id="tableCaption" class="sr-only">User typing results</caption>
                    <thead>
                        <tr>
                            <th data-key="name">Name <span class="sort" aria-hidden="true">↕</span></th>
                            <th data-key="email">Email <span class="sort" aria-hidden="true">↕</span></th>
                            <th data-key="hallTicket">Hall Ticket <span class="sort" aria-hidden="true">↕</span></th>
                            <th data-key="wpm" title="Words Per Minute">WPM <span class="sort" aria-hidden="true">↕</span></th>
                            <th data-key="accuracy" title="Accuracy">Accuracy <span class="sort" aria-hidden="true">↕</span></th>
                            <th data-key="testTakenTime" title="Test Taken time">Test taken date <span class="sort" aria-hidden="true">↕</span></th>
                        </tr>
                    </thead>
                    <tbody id="tbody">
                        <!-- Rows will render here -->
                    </tbody>
                </table>
            </div>

            <div id="empty" class="empty" hidden>
                No data found in localStorage under "typingresult".
                <div style="margin-top:10px">Expecting a JSON array like:</div>
                <pre class="mono" style="text-align:left; white-space:pre-wrap; background:transparent; border:1px dashed var(--border); padding:10px; border-radius:8px; margin:12px auto; max-width:720px;">
[
    {"name":"Alice","email":"alice@example.com","hallTicket":"HT123","wpm":72},
    {"name":"Bob","email":"bob@example.com","hallTicket":"HT456","wpm":65}
]
                </pre>
            </div>

            <div class="meta">
                <div>Last loaded: <span id="loadedAt" class="mono">—</span></div>
                <div class="muted">Tip: Update localStorage in another tab to see live refresh.</div>
            </div>
        </section>
    </div>

    <script>
        (() => {
            const STORAGE_KEY = "typingResults";

            const el = {
                tbody: document.getElementById("tbody"),
                count: document.getElementById("count"),
                search: document.getElementById("search"),
                empty: document.getElementById("empty"),
                loadedAt: document.getElementById("loadedAt"),
                refreshBtn: document.getElementById("refreshBtn"),
                exportBtn: document.getElementById("exportBtn"),
                table: document.getElementById("table"),
            };

            let raw = [];
            let view = [];
            let sortState = { key: "wpm", dir: "desc" };

            function parseMaybeJSON(val){
                if (val == null) return null;
                try { return JSON.parse(val); } catch { return null; }
            }

            function coerceWpm(x){
                if (x == null) return null;
                if (typeof x === "number" && Number.isFinite(x)) return x;
                const s = String(x).toLowerCase().replace(/[^0-9.]+/g, "");
                const n = parseFloat(s);
                return Number.isFinite(n) ? n : null;
            }

            function normalizeItem(item){
                // Allow flexible input property names
                const name = item.name ?? item.username ?? item.userName ?? item.fullName ?? [item.firstName, item.lastName].filter(Boolean).join(" ") ?? "";
                const email = item.email ?? item.emailAddress ?? item.mail ?? "";
                const hallTicket =
                    item.hallTicket ?? item.hallticket ?? item.hall_ticket ?? item.hallTicketNumber ??
                    item.hallticketnumber ?? item.ticket ?? item.roll ?? item.rollNo ?? item.rollNumber ?? "";
                const wpm = coerceWpm(item.wpm ?? item.WPM ?? item.wordsPerMinute ?? item.speed ?? item.typingSpeed ?? item.score);
                const accuracy = item.accuracy;
               
                const testTakenTime = item.testTakenTime;
                return { name: String(name || "").trim(), email: String(email || "").trim(), hallTicket: String(hallTicket || "").trim(), wpm: wpm ?? 0,accuracy:accuracy,testTakenTime:testTakenTime };
            }

            function loadFromStorage(){
                const data = parseMaybeJSON(localStorage.getItem(STORAGE_KEY));
                if (!Array.isArray(data)) return [];
                return data.map((x, i) => {
                    const base = (x && typeof x === "object") ? x : { value: x };
                    const normalized = normalizeItem(base);
                    // attach original index for stable sorting
                    return { ...normalized, _i: i };
                });
            }

            function applySearch(arr, q){
                if (!q) return arr;
                const term = q.trim().toLowerCase();
                if (!term) return arr;
                return arr.filter(r =>
                    (r.name || "").toLowerCase().includes(term) ||
                    (r.email || "").toLowerCase().includes(term) ||
                    (r.hallTicket || "").toLowerCase().includes(term) ||
                    String(r.wpm).toLowerCase().includes(term) ||
                    String(r.accuracy).toLowerCase().includes(term) ||
                    r.testTakenTime.includes(term)
                );
            }

            function sortBy(arr, key, dir){
                const mul = dir === "desc" ? -1 : 1;
                const cmp = (a, b) => {
                    const va = a[key], vb = b[key];
                    if (key === "wpm") {
                        const na = Number(va) || 0, nb = Number(vb) || 0;
                        if (na !== nb) return (na < nb ? -1 : 1) * mul;
                    } else {
                        const sa = String(va || "").toLowerCase();
                        const sb = String(vb || "").toLowerCase();
                        if (sa !== sb) return (sa < sb ? -1 : 1) * mul;
                    }
                    // stable
                    return (a._i - b._i);
                };
                return [...arr].sort(cmp);
            }

            function fmtNumber(n){
                return new Intl.NumberFormat(undefined, { maximumFractionDigits: 0 }).format(n ?? 0);
            }

            function render(){
                el.tbody.innerHTML = "";
                if (!view.length){
                    el.empty.hidden = false;
                    el.count.textContent = "";
                    return;
                }
                el.empty.hidden = true;
                const frag = document.createDocumentFragment();
                for (const r of view){
                    const tr = document.createElement("tr");

                    const tdName = document.createElement("td");
                    tdName.textContent = r.name || "—";
                    tr.appendChild(tdName);

                    const tdEmail = document.createElement("td");
                    tdEmail.innerHTML = r.email ? `<span class="mono">${escapeHtml(r.email)}</span>` : "<span class='muted'>—</span>";
                    tr.appendChild(tdEmail);

                    const tdHall = document.createElement("td");
                    tdHall.innerHTML = r.hallTicket ? `<span class="mono">${escapeHtml(r.hallTicket)}</span>` : "<span class='muted'>—</span>";
                    tr.appendChild(tdHall);

                    const tdWpm = document.createElement("td");
                    tdWpm.innerHTML = `<span class="badge" title="${r.wpm} words per minute">${fmtNumber(r.wpm)} wpm</span>`;
                    tr.appendChild(tdWpm);

                    const tdAccuracy = document.createElement("td");
                    tdAccuracy.innerHTML = `<span class="badge" title="${r.accuracy} Accuracy">${fmtNumber(r.accuracy)}%</span>`;
                    tr.appendChild(tdAccuracy);

                    const tdTestTakenTime = document.createElement("td");
                    tdTestTakenTime.innerHTML = `<span class="mono">${r.testTakenTime}</span>`;
                    tr.appendChild(tdTestTakenTime);

                    frag.appendChild(tr);
                }
                el.tbody.appendChild(frag);
                el.count.textContent = `${view.length} record${view.length === 1 ? "" : "s"}`;
            }

            function escapeHtml(s){
                return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
            }

            function refresh(){
                raw = loadFromStorage();
                const q = el.search.value;
                const filtered = applySearch(raw, q);
                view = sortBy(filtered, sortState.key, sortState.dir);
                el.loadedAt.textContent = new Date().toLocaleString();
                render();
                highlightSort();
            }

            function highlightSort(){
                const ths = el.table.querySelectorAll("thead th");
                ths.forEach(th => {
                    th.style.color = "var(--muted)";
                    th.style.textDecoration = "none";
                });
                const active = el.table.querySelector(`thead th[data-key="${sortState.key}"]`);
                if (active){
                    active.style.color = "var(--text)";
                    active.style.textDecoration = "underline";
                    active.title = `Sorted by ${sortState.key} (${sortState.dir})`;
                    const sortSpan = active.querySelector(".sort");
                    if (sortSpan) sortSpan.textContent = sortState.dir === "asc" ? "↑" : "↓";
                }
            }

            function exportCSV(rows){
                const header = ["name","email","hallTicket","wpm", "accuracy","testTakenTime"];
                const lines = [
                    header.join(","),
                    ...rows.map(r => header.map(k => toCSVCell(r[k])).join(","))
                ];
                const csv = lines.join("\r\n");
                const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "typingresults.csv";
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            }
            function toCSVCell(v){
                if (v == null) return "";
                let s = String(v);
                if (/[",\r\n]/.test(s)) s = `"${s.replace(/"/g, '""')}"`;
                return s;
            }

            // Events
            el.search.addEventListener("input", () => refresh());
            el.refreshBtn.addEventListener("click", () => refresh());
            el.exportBtn.addEventListener("click", () => exportCSV(view));
           
            // Sort by clicking headers
            el.table.querySelectorAll("thead th").forEach(th => {
                th.addEventListener("click", () => {
                    const key = th.getAttribute("data-key");
                    if (!key) return;
                    sortState.dir = (sortState.key === key && sortState.dir === "asc") ? "desc" : (sortState.key === key ? "asc" : "desc");
                    sortState.key = key;
                    refresh();
                });
            });
            // Live update when localStorage changes from other tabs
            window.addEventListener("storage", (e) => {
                if (e.key === STORAGE_KEY) refresh();
            });

            // Initial load
            refresh();

           
        })();
    </script>
</body>
</html>